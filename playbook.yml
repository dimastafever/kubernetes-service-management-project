---
- name: Prepare Kubernetes cluster on Astra Linux 1.8
  hosts: k8s_cluster
  become: yes
  gather_facts: no

  tasks:
    - name: Fix broken repositories
      shell: |
        # Комментируем проблемные репозитории
        sed -i 's|^deb.*download.astralinux.ru.*devel|# &|g' /etc/apt/sources.list
        sed -i 's|^deb.*download.astralinux.ru.*devel|# &|g' /etc/apt/sources.list.d/*.list 2>/dev/null || true
        
        # Создаем рабочий sources.list
        cat > /tmp/sources.list.tmp << 'EOF'
        deb http://download.astralinux.ru/astra/stable/1.8_x86-64/repository-main/ 1.8_x86-64 main contrib non-free
        deb http://download.astralinux.ru/astra/stable/1.8_x86-64/repository-extended/ 1.8_x86-64 main contrib non-free
        EOF
        
        # Проверяем, есть ли основные репозитории
        if ! grep -q "repository-main" /etc/apt/sources.list; then
          cat /tmp/sources.list.tmp >> /etc/apt/sources.list
        fi
        
        rm -f /tmp/sources.list.tmp

    - name: Update apt cache (игнорируем ошибки)
      shell: |
        apt-get update 2>&1 | grep -v "Failed" || echo "Update completed with warnings"
      ignore_errors: yes

    - name: Install basic dependencies
      apt:
        name:
          - curl
          - wget
          - gnupg
          - ca-certificates
          - software-properties-common
        state: present
      ignore_errors: yes

    - name: Install Docker (без добавления репозитория через модуль)
      block:
        - name: Install docker.io from default repo
          apt:
            name: docker.io
            state: present
          ignore_errors: yes

        - name: Or try to install docker-ce manually
          shell: |
            # Попробовать добавить Docker репозиторий вручную
            curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg 2>/dev/null || true
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian buster stable" > /etc/apt/sources.list.d/docker.list 2>/dev/null || true
            apt-get update 2>/dev/null || true
            apt-get install -y docker-ce docker-ce-cli containerd.io 2>/dev/null || true
          ignore_errors: yes
          when: false  # Отключено, но оставлено как запасной вариант

      rescue:
        - name: Last resort - install docker from any source
          shell: |
            apt-get install -y docker 2>/dev/null || apt-get install -y docker-engine 2>/dev/null || echo "Cannot install Docker"
          ignore_errors: yes

    - name: Start Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Disable swap
      shell: |
        swapoff -a
        sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

    - name: Configure kernel for Kubernetes
      shell: |
        echo "net.bridge.bridge-nf-call-iptables = 1" >> /etc/sysctl.conf
        echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
        sysctl -p
        modprobe overlay 2>/dev/null || true
        modprobe br_netfilter 2>/dev/null || true

    - name: Install Kubernetes binaries from direct download
      shell: |
        # Установить необходимые утилиты
        apt-get install -y curl wget tar 2>/dev/null || true
        
        # Создать директорию для бинарников
        mkdir -p /usr/local/bin
        
        # Скачать kubeadm (версия 1.24.0 - стабильная)
        echo "Downloading Kubernetes binaries..."
        
        # Попробовать несколько источников
        for attempt in 1 2 3; do
          echo "Attempt $attempt..."
          
          # Скачать напрямую
          if wget -q -O /tmp/kubeadm https://dl.k8s.io/release/v1.24.0/bin/linux/amd64/kubeadm; then
            echo "kubeadm downloaded"
            wget -q -O /tmp/kubectl https://dl.k8s.io/release/v1.24.0/bin/linux/amd64/kubectl || true
            wget -q -O /tmp/kubelet https://dl.k8s.io/release/v1.24.0/bin/linux/amd64/kubelet || true
            break
          fi
          
          # Альтернативный источник
          if curl -fL -o /tmp/kubeadm https://storage.googleapis.com/kubernetes-release/release/v1.24.0/bin/linux/amd64/kubeadm; then
            echo "kubeadm downloaded from alternative source"
            curl -fL -o /tmp/kubectl https://storage.googleapis.com/kubernetes-release/release/v1.24.0/bin/linux/amd64/kubectl || true
            curl -fL -o /tmp/kubelet https://storage.googleapis.com/kubernetes-release/release/v1.24.0/bin/linux/amd64/kubelet || true
            break
          fi
          
          sleep 2
        done
        
        # Установить бинарники
        if [ -f /tmp/kubeadm ]; then
          chmod +x /tmp/kubeadm /tmp/kubectl /tmp/kubelet 2>/dev/null || true
          mv /tmp/kubeadm /tmp/kubectl /tmp/kubelet /usr/local/bin/ 2>/dev/null || true
          echo "Kubernetes binaries installed to /usr/local/bin/"
        else
          echo "Warning: Could not download Kubernetes binaries"
        fi
        
        # Проверить установку
        /usr/local/bin/kubeadm version 2>/dev/null || echo "kubeadm not installed"
      ignore_errors: yes

- name: Configure master node
  hosts: master
  become: yes
  tasks:
    - name: Create kubeadm configuration
      shell: |
        mkdir -p /etc/kubernetes

        cat > /etc/kubernetes/kubeadm-config.yaml << 'EOF'
        apiVersion: kubeadm.k8s.io/v1beta3
        kind: InitConfiguration
        nodeRegistration:
          criSocket: "unix:///var/run/docker.sock"
          kubeletExtraArgs:
            cgroup-driver: "systemd"
        ---
        apiVersion: kubeadm.k8s.io/v1beta3
        kind: ClusterConfiguration
        kubernetesVersion: "v1.24.0"
        controlPlaneEndpoint: "192.168.1.74:6443"
        apiServer:
          extraArgs:
            authorization-mode: Node,RBAC
        networking:
          podSubnet: "10.244.0.0/16"
          serviceSubnet: "10.96.0.0/12"
          dnsDomain: "cluster.local"
        imageRepository: "registry.k8s.io"
        EOF

        echo "Kubeadm config created at /etc/kubernetes/kubeadm-config.yaml"

    - name: Create kubelet systemd service
      shell: |
        cat > /etc/systemd/system/kubelet.service << 'EOF'
        [Unit]
        Description=kubelet: The Kubernetes Node Agent
        Documentation=https://kubernetes.io/docs/home/
        Wants=network-online.target
        After=network-online.target

        [Service]
        ExecStart=/usr/local/bin/kubelet --cgroup-driver=systemd --container-runtime=remote --container-runtime-endpoint=unix:///var/run/docker.sock --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin
        Restart=always
        StartLimitInterval=0
        RestartSec=10

        [Install]
        WantedBy=multi-user.target
        EOF

        mkdir -p /var/lib/kubelet
        mkdir -p /etc/cni/net.d
        mkdir -p /opt/cni/bin

        systemctl daemon-reload
        systemctl enable kubelet

    - name: Display next steps
      debug:
        msg: |
          Установка завершена!
          
          Для инициализации кластера выполните на master-узле (192.168.1.74):
          
          ssh adminstd@192.168.1.74
          
          Затем:
          sudo /usr/local/bin/kubeadm init --config /etc/kubernetes/kubeadm-config.yaml --ignore-preflight-errors=all
          
          После успешной инициализации:
          1. Скопируйте команду 'kubeadm join' из вывода
          2. Настройте kubectl:
             mkdir -p $HOME/.kube
             sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
             sudo chown $(id -u):$(id -g) $HOME/.kube/config
          3. Установите сетевой плагин:
             kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
          4. Выполните команду join на worker-узлах